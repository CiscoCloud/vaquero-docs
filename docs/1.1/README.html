<head>

<meta charset="UTF-8"> <!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]--> <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
Vaquero README
</title>

<link rel="stylesheet" type="text/css" href="../doc.css"> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400">
<style>
                .markdown-body {
                    box-sizing: border-box;
                    min-width: 200px;
                    max-width: 980px;
                    margin: 0 auto;
                    padding: 45px;
                }
            </style>
</head><article class="markdown-body">

<h1 id="vaquero">Vaquero</h1>
<p><a href="https://ciscocloud.github.io/vaquero-docs/">Home</a></p>
<p><a href="https://github.com/CiscoCloud/vaquero-docs/tree/master">Docs Repo</a></p>
<p><a href="https://drone.projectshipped.io/CiscoCloud/vaquero"><img src="https://drone.projectshipped.io/api/badges/CiscoCloud/vaquero/status.svg" alt="Build Status" /></a></p>
<ul>
<li><a href="https://github.com/CiscoCloud/vaquero">Private Dev Repo</a> : Vaquero's development home</li>
<li><a href="https://waffle.io/CiscoCloud/vaquero">Waffle.io Issue Tracking</a>: Progress tracking tool</li>
</ul>
<p>A bare metal configuration utility that network boots machines based on user defined templates. We leverage iPXE and support cloud-config, ignition, kickstart, and untyped unattend boot scripts. The only requirement to deploy vaquero is docker. See the <a href="https://ciscocloud.github.io/vaquero-docs/docs/1.1/getting-started.html">Getting Started</a> page for details on deploying vaquero in virtualbox.</p>
<h1 id="architecture"><a href="https://ciscocloud.github.io/vaquero-docs/docs/1.1/architecture.html">Architecture</a></h1>
<div class="figure">
<img src="https://raw.githubusercontent.com/CiscoCloud/vaquero-docs/gh-pages/docs/1.1/ppt-arch.png" />
</div>
<h2 id="data-model-templates-in-depth"><a href="https://ciscocloud.github.io/vaquero-docs/docs/1.1/data-model-howto.html">Data Model Templates In Depth</a></h2>
<p>Data Models are used by vaquero as the &quot;Source of Truth&quot; to describe your data center. Data Models define machine operating systems, subnets and boot scripts. We provide some <a href="https://github.com/CiscoCloud/vaquero-examples">example data models</a> as a reference to build your own.</p>
<p>Notable branches in the example repo:</p>
<ul>
<li><p><a href="https://github.com/CiscoCloud/vaquero-examples"><code>master</code></a>: This will be updated to reflect a complete data model for reference. We will keep this single branch updated when an example of every supported feature, model type, and workflow is up.</p></li>
<li><p><a href="https://github.com/CiscoCloud/vaquero-examples/tree/local"><code>local</code></a>: Used for CI functional testing. We currently test at two commits in the history. <a href="https://github.com/CiscoCloud/vaquero-examples/commit/3d0df2db8f04eaeaa30e0542d42aa9d861324e4e">Init</a> and <a href="https://github.com/CiscoCloud/vaquero-examples/commit/b228c2291c3ae87685b25d1435bfe450bf40456b">Update</a>.</p></li>
<li><p><a href="https://github.com/CiscoCloud/vaquero-examples/tree/vagrant"><code>vagrant</code></a>: Used for small deployments via vagrant in virtualbox. This branch may not show every feature, but it will be leveraged as a small scale example Data Model to deploy a few machines at most.</p></li>
</ul>
<h2 id="project-requirements"><a href="https://ciscocloud.github.io/vaquero-docs/docs/1.1/requirements.html">Project Requirements</a></h2>
<h2 id="configuring-and-running-vaquero">Configuring and Running Vaquero</h2>
<p>Vaquero can run in multiple modes: <code>server</code>, <code>agent</code>, and <code>standalone</code>. This configuration is for standalone mode, which runs server and agent in the same container. See the <a href="https://ciscocloud.github.io/vaquero-docs/docs/1.1/architecture.html">architecture page</a> for more details about server and agent.</p>
<ul>
<li>See the <a href="architecture%20page](https://ciscocloud.github.io/vaquero-docs/docs/1.1/getting-started.html)">Getting Started</a> page for details on deploying vaquero in virtualbox.</li>
</ul>
<p><strong>sample-standalone-config.yaml</strong> ************************************************************</p>
<pre><code>ServerApi:
  Address: &quot;127.0.0.1&quot;
  Port: 24601
AgentApi:
  InsecureAddr: &quot;127.0.0.1&quot;
  InsecurePort: 24602
AssetServer:
  Addr: &quot;127.0.0.1&quot;
  Port: 8080
  BaseDir: &quot;/tmp/vaquero/files&quot;
  Scheme: http
DHCPMode: server
SavePath: &quot;/tmp/vaquero&quot;
Gitter:
  Endpoint: &quot;/postreceive&quot;
  Timeout: 2
  Addr: &quot;127.0.0.1&quot;
  Port: 9090
GitHook:
  - ID: &quot;vaquero-local&quot;
    Token: &lt;GIT_TOKEN&gt;
    URL: &quot;https://github.com/CiscoCloud/vaquero-examples&quot;
    Secret: &lt;GIT_SECRET&gt;
LocalDir:
  PollInterval: 10
SoT:
- Git:
    HookID: &quot;vaquero-local&quot;
    ID: &quot;vaquero-test&quot;
    Branch: local
- Local:
    ID: vaquero-local2
    Root: /vagrant/local
Log:
  Level: info
  Location: stdout
  LogType: text
</code></pre>
<hr />
<h4 id="explanation-of-config-fields">Explanation of config fields:</h4>
<ul>
<li>ServerApi: The user api for the server. Currently not implemented.</li>
<li>AgentApi: The vaquero-agent http server used to listen for vaquero server commands.</li>
<li>AssetServer: The asset server for vaquero agent used by each booting machine to get unattended scripts and kernels.</li>
<li><p>DHCPMode: <code>proxy</code>, <code>server</code>. Leaving the DHCPMode field empty will disable all DHCP vaquero functionality.</p>
<ul>
<li><p>DHCPMode: Proxy enables ProxyDHCP. ProxyDHCP works with an existing DHCP Server to provide PXEBoot functionality, while leaving the managing and assigning of IP addresses to the other DHCP Server. ONLY enable this if you already have a DHCP server with entries for all the hosts in your Data Model.</p></li>
<li><p>DHCPMode: server runs vaquero as a DHCP server. Vaquero does not manage free address pools or leases; it simply assigns based of the static configuration defined in the data model.</p></li>
</ul></li>
<li>SavePath: The vaquero server location to save local configurations on disk.</li>
<li>Gitter: Configuration for listening to git webhooks.</li>
<li>GitHook: An array for all githooks to listen to.</li>
<li>LocalDir: PollInterval is the number of seconds between checks to that directory for updates.</li>
<li>SoT: An array for specific sources of truth. Git updater, that used github as its source of truth, receives webhooks from github. Local: will use a local directory to update.</li>
<li><p>Log: The base configuration for the project logr.</p></li>
</ul>
<h2 id="running-vaquero-from-the-container">Running Vaquero from the container</h2>
<p><a href="https://bintray.com/shippedrepos/vaquero/vaquero%3Avaquero">Bintray Docker Images</a></p>
<ol style="list-style-type: decimal">
<li>Fetch the image: <code>docker pull shippedrepos-docker-vaquero.bintray.io/vaquero/vaquero:latest</code></li>
<li><p>Run the example: <code>docker run -v /vagrant/vagrant-config.yaml:/vaquero/config.yaml -v /files:/tmp/vaquero/files --network=&quot;host&quot; shippedrepos-docker-vaquero.bintray.io/vaquero/vaquero:latest standalone --config /vaquero/config.yaml</code></p>
<ol style="list-style-type: decimal">
<li><code>docker volume</code> to pass the configuration into the container.</li>
<li><code>docker volume</code> to pass in the assetServer assets (kernel images, <code>undionly.kpxe</code>, etc)</li>
<li>set networking to <code>host</code></li>
</ol></li>
</ol>
<h2 id="vaquero-with-systemd">Vaquero with Systemd</h2>
<p>Vaquero can be started as a service using Systemd and Docker.</p>
<p><strong>/etc/systemd/system/vaquero.service</strong> ************************************************************</p>
<pre><code>[Unit]
Description=Vaquero Container
Requires=docker.service
After=docker.service

[Service]
Restart=always
ExecStart=/usr/bin/docker run --net host -v /var/vaquero/config.yaml:/config.yaml -v /var/vaquero/files:/var --name vaquero shippedrepos-docker-vaquero.bintray.io/vaquero/vaquero:latest standalone --config /config.yaml
ExecStop=/usr/bin/docker stop vaquero
ExecStopPost=/usr/bin/docker rm -f vaquero

[Install]
WantedBy=default.target</code></pre>
<hr />
<p>This example does:</p>
<ol style="list-style-type: decimal">
<li>Starts a Docker container named <code>vaquero</code> after the Docker service has started.</li>
<li>It starts using the parameters passed into <code>ExecStart</code></li>
<li><code>ExecStop</code> stops the <code>vaquero</code> container and is run when stopping the service.</li>
<li><code>ExecStopPost</code> removes the <code>vaquero</code> container and is run after stopping the service.</li>
<li>It tries to restart the service.</li>
</ol>
<p>Tips:</p>
<ol style="list-style-type: decimal">
<li>Make sure the Docker service is enabled on startup <code>sudo systemctl enable docker</code></li>
<li>Check that the <code>vaquero</code> service isn't dying <code>sudo systemctl status vaquero</code></li>
<li>See if the Docker container exists <code>sudo docker ps</code></li>
<li>Flush the changes <code>sudo systemctl daemon-reload</code></li>
<li>Restart both the <code>docker</code> and the <code>vaquero</code> services <code>sudo systemctl restart docker</code></li>
<li>Make sure that pathing is correct for config and files required</li>
</ol>
<h2 id="vaquero-validate"><a href="https://ciscocloud.github.io/vaquero-docs/docs/1.1/validator.html">Vaquero Validate</a></h2>
<p>CLI tool that is for validating your data model before you push it through Vaquero</p>
<h2 id="sending-webhooks-to-vaquero-master">Sending Webhooks to Vaquero Master</h2>
<ol style="list-style-type: decimal">
<li>Install <a href="https://ngrok.com/">ngrok</a> to your local machine, unzip the package, and move the executable to <code>/usr/local/bin</code>.</li>
<li>Run ngrok on your physical machine <code>ngrok http 127.0.0.1:4816</code> or <code>ngrok http 4816</code>.
<ol style="list-style-type: decimal">
<li>Make sure that the address and port are the same as the Git Hook server in the config.</li>
<li>It should follow <code>ngrok http &lt;Gitter.Addr&gt;:&lt;Gitter.Port&gt;</code></li>
</ol></li>
<li>Create a testing repo to launch webhooks from.</li>
<li>Give github.com the http endpoint provided by ngrok <code>http://0000ffff.ngrok.io/postreceive/vaquero-local</code>.
<ol style="list-style-type: decimal">
<li>This should be something like <code>&lt;ngrok address&gt;/&lt;Gitter.Endpoint&gt;/&lt;GitHook.ID&gt;</code>.</li>
<li>The <code>Gitter.Endpoint</code> and the <code>GitHook.ID</code> are from the config.</li>
</ol></li>
<li>Launch a webhook to hit the ngrok address.
<ol style="list-style-type: decimal">
<li>The <code>GitHook.Username</code>,<code>GitHook.Password</code>, and <code>GitHook.Secret</code> should be set in configuration to connect to the webhook of the <code>GitHook.URL</code>.</li>
<li>Note that the <code>GitHook.Secret</code> can be left blank and should correspond to the Secret created when setting up the webhook on GitHub.</li>
<li>Pushing to the repo, or <code>Redeliver Payload</code> on GitHub will launch a webhook.</li>
</ol></li>
</ol>
<h2 id="docs">Docs</h2>
<p>Build the documentation by running <code>godoc -http &lt;port&gt;</code> and open <code>localhost:&lt;port&gt;</code> on your web browser</p>
<h2 id="questions-comments-feedback">Questions / Comments / Feedback</h2>
<p>To provide feedback to the team please email: <script type="text/javascript">
<!--
h='&#x65;&#120;&#116;&#x65;&#114;&#110;&#x61;&#108;&#46;&#x63;&#x69;&#x73;&#x63;&#x6f;&#46;&#x63;&#x6f;&#x6d;';a='&#64;';n='&#118;&#x61;&#x71;&#x75;&#x65;&#114;&#x6f;&#x2d;&#102;&#x65;&#x65;&#100;&#98;&#x61;&#x63;&#x6b;';e=n+a+h;
document.write('<a h'+'ref'+'="ma'+'ilto'+':'+e+'">'+e+'<\/'+'a'+'>');
// -->
</script><noscript>&#118;&#x61;&#x71;&#x75;&#x65;&#114;&#x6f;&#x2d;&#102;&#x65;&#x65;&#100;&#98;&#x61;&#x63;&#x6b;&#32;&#x61;&#116;&#32;&#x65;&#120;&#116;&#x65;&#114;&#110;&#x61;&#108;&#32;&#100;&#x6f;&#116;&#32;&#x63;&#x69;&#x73;&#x63;&#x6f;&#32;&#100;&#x6f;&#116;&#32;&#x63;&#x6f;&#x6d;</noscript> For Issues, open at <a href="https://github.com/CiscoCloud/vaquero-docs/issues">CiscoCloud/vaquero-docs</a></p>
